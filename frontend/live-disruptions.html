<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Disruptions - Safegrid Navigator</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <!-- Chart.js for stock-style charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            background: white;
            border-radius: 15px;
            padding: 20px 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            color: #667eea;
            font-size: 2em;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-links {
            display: flex;
            gap: 15px;
        }

        .nav-links a {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .nav-links a:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }

        .nav-links a.active {
            background: #764ba2;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .full-width-card {
            grid-column: 1 / -1;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 10px;
        }

        #map {
            height: 700px;
            border-radius: 10px;
            border: 3px solid #e0e0e0;
        }

        .disruption-sidebar {
            max-height: 700px;
            overflow-y: auto;
        }

        .disruption-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 5px solid #667eea;
            cursor: pointer;
            transition: all 0.3s;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .disruption-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .disruption-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .disruption-type {
            font-weight: 700;
            color: #667eea;
            text-transform: uppercase;
            font-size: 0.9em;
        }

        .severity-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 700;
        }

        .severity-high {
            background: #f44336;
            color: white;
        }

        .severity-medium {
            background: #ff9800;
            color: white;
        }

        .severity-low {
            background: #4caf50;
            color: white;
        }

        .disruption-description {
            color: #666;
            font-size: 0.9em;
            margin: 8px 0;
        }

        .disruption-location {
            color: #999;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 8px;
        }

        .filter-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            background: #e0e0e0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85em;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
        }

        .live-indicator {
            width: 12px;
            height: 12px;
            background: #4caf50;
            border-radius: 50%;
            animation: pulse 2s infinite;
            display: inline-block;
            margin-right: 8px;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.3;
            }
        }

        .stats-bar {
            display: flex;
            gap: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            color: white;
            margin-bottom: 20px;
        }

        .stat-item {
            flex: 1;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 700;
        }

        .stat-label {
            font-size: 0.85em;
            opacity: 0.9;
        }

        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-broadcast-tower"></i> Live Disruption Feed</h1>
            <div class="nav-links">
                <a href="index.html"><i class="fas fa-home"></i> Home</a>
                <a href="live-disruptions.html" style="background: #764ba2;"><i class="fas fa-broadcast-tower"></i> Live Feed</a>
            </div>
        </header>

        <!-- Statistics Bar -->
        <div class="stats-bar" id="statsBar">
            <div class="stat-item">
                <div class="stat-value" id="totalDisruptions">0</div>
                <div class="stat-label">Total Active</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="highSeverity">0</div>
                <div class="stat-label">High Severity</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="mediumSeverity">0</div>
                <div class="stat-label">Medium Severity</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="lowSeverity">0</div>
                <div class="stat-label">Low Severity</div>
            </div>
        </div>

        <!-- Stock-Style Risk Trend Chart -->
        <div class="card full-width-card">
            <h2>
                <span><i class="fas fa-chart-line"></i> 30-Day Risk Trend Analysis</span>
                <span style="font-size: 0.85em; font-weight: normal; color: #999;">
                    <i class="fas fa-info-circle"></i> Historical disruption severity trends
                </span>
            </h2>
            <div class="chart-container">
                <canvas id="riskTrendChart"></canvas>
            </div>
        </div>

        <div class="main-layout">
            <div class="card">
                <h2>
                    <span><i class="fas fa-globe"></i> Global Disruption Map</span>
                    <span style="font-size: 0.9em; font-weight: normal;">
                        <span class="live-indicator"></span>Live
                    </span>
                </h2>
                <div id="map"></div>
            </div>

            <div class="card">
                <h2><i class="fas fa-list"></i> Active Disruptions</h2>
                
                <div class="filter-section">
                    <button class="filter-btn active" onclick="filterBySeverity('all')">All</button>
                    <button class="filter-btn" onclick="filterBySeverity('high')">High</button>
                    <button class="filter-btn" onclick="filterBySeverity('medium')">Medium</button>
                    <button class="filter-btn" onclick="filterBySeverity('low')">Low</button>
                </div>

                <div class="disruption-sidebar" id="disruptionList">
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2em;"></i>
                        <p style="margin-top: 10px;">Loading disruptions...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API_BASE = 'http://localhost:5000/api';
        let allDisruptions = [];
        let currentFilter = 'all';
        let riskChart = null;
        
        // Initialize map
        const map = L.map('map').setView([20, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
            maxZoom: 18
        }).addTo(map);

        let markers = [];

        // Generate mock 30-day risk data
        function generate30DayRiskData() {
            const days = 30;
            const today = new Date();
            const data = {
                cyclone: [],
                portCongestion: [],
                piracy: [],
                navigationalHazard: []
            };

            for (let i = days - 1; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                
                // Cyclone Risk: generally low with 1-2 sudden spikes
                let cycloneRisk = 15 + Math.random() * 15; // Base 15-30
                if (i === 22 || i === 8) {
                    cycloneRisk = 75 + Math.random() * 20; // Spikes at day 22 and 8
                }
                
                // Port Congestion: slow upward/downward slope
                const portBase = 40 + (i * 0.8); // Gradual increase
                const portCongestion = portBase + (Math.random() * 10 - 5);
                
                // Piracy Risk: medium variability
                const piracyBase = 45;
                const piracy = piracyBase + (Math.sin(i / 5) * 15) + (Math.random() * 10 - 5);
                
                // Navigational Hazard: stable with slight changes
                const navBase = 30;
                const navHazard = navBase + (Math.random() * 8 - 4);
                
                data.cyclone.push({x: date, y: Math.max(0, Math.min(100, cycloneRisk))});
                data.portCongestion.push({x: date, y: Math.max(0, Math.min(100, portCongestion))});
                data.piracy.push({x: date, y: Math.max(0, Math.min(100, piracy))});
                data.navigationalHazard.push({x: date, y: Math.max(0, Math.min(100, navHazard))});
            }
            
            return data;
        }

        // Initialize stock-style chart
        function initializeRiskChart() {
            const ctx = document.getElementById('riskTrendChart').getContext('2d');
            const riskData = generate30DayRiskData();
            
            riskChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Cyclone Risk',
                            data: riskData.cyclone,
                            borderColor: '#f44336',
                            backgroundColor: 'rgba(244, 67, 54, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            pointHoverBackgroundColor: '#f44336',
                            pointHoverBorderColor: '#fff',
                            pointHoverBorderWidth: 2
                        },
                        {
                            label: 'Port Congestion',
                            data: riskData.portCongestion,
                            borderColor: '#ff9800',
                            backgroundColor: 'rgba(255, 152, 0, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            pointHoverBackgroundColor: '#ff9800',
                            pointHoverBorderColor: '#fff',
                            pointHoverBorderWidth: 2
                        },
                        {
                            label: 'Piracy Risk',
                            data: riskData.piracy,
                            borderColor: '#9c27b0',
                            backgroundColor: 'rgba(156, 39, 176, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            pointHoverBackgroundColor: '#9c27b0',
                            pointHoverBorderColor: '#fff',
                            pointHoverBorderWidth: 2
                        },
                        {
                            label: 'Navigational Hazard',
                            data: riskData.navigationalHazard,
                            borderColor: '#2196f3',
                            backgroundColor: 'rgba(33, 150, 243, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            pointHoverBackgroundColor: '#2196f3',
                            pointHoverBorderColor: '#fff',
                            pointHoverBorderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: {
                                    size: 12,
                                    weight: '600'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#333',
                            bodyColor: '#666',
                            borderColor: '#ddd',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                title: function(context) {
                                    const date = new Date(context[0].parsed.x);
                                    return date.toLocaleDateString('en-US', { 
                                        month: 'short', 
                                        day: 'numeric', 
                                        year: 'numeric' 
                                    });
                                },
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '/100';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                displayFormats: {
                                    day: 'MMM d'
                                }
                            },
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                font: {
                                    size: 11
                                },
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            min: 0,
                            max: 100,
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value;
                                },
                                font: {
                                    size: 11
                                }
                            },
                            title: {
                                display: true,
                                text: 'Risk Severity Level (0-100)',
                                font: {
                                    size: 13,
                                    weight: '600'
                                }
                            }
                        }
                    }
                }
            });
        }

        // Load global disruptions
        async function loadDisruptions() {
            try {
                const response = await fetch(`${API_BASE}/global_map_data`);
                const data = await response.json();
                
                allDisruptions = data.disruptions;
                updateStatistics();
                displayDisruptions();
                updateMap();
            } catch (error) {
                console.error('Error loading disruptions:', error);
            }
        }

        // Update statistics
        function updateStatistics() {
            const counts = {
                high: allDisruptions.filter(d => d.severity === 'high').length,
                medium: allDisruptions.filter(d => d.severity === 'medium').length,
                low: allDisruptions.filter(d => d.severity === 'low').length
            };

            document.getElementById('totalDisruptions').textContent = allDisruptions.length;
            document.getElementById('highSeverity').textContent = counts.high;
            document.getElementById('mediumSeverity').textContent = counts.medium;
            document.getElementById('lowSeverity').textContent = counts.low;
        }

        // Display disruptions in sidebar
        function displayDisruptions() {
            let filtered = allDisruptions;
            
            if (currentFilter !== 'all') {
                filtered = allDisruptions.filter(d => d.severity === currentFilter);
            }

            const html = filtered.map((d, index) => `
                <div class="disruption-item" onclick="flyToDisruption(${index})">
                    <div class="disruption-header">
                        <span class="disruption-type">${d.type.replace(/_/g, ' ')}</span>
                        <span class="severity-badge severity-${d.severity}">${d.severity.toUpperCase()}</span>
                    </div>
                    <div class="disruption-description">${d.description}</div>
                    <div class="disruption-location">
                        <i class="fas fa-map-marker-alt"></i> ${d.location.name}
                    </div>
                </div>
            `).join('');

            document.getElementById('disruptionList').innerHTML = html || '<p style="text-align: center; color: #999; padding: 20px;">No disruptions found</p>';
        }

        // Update map markers
        function updateMap() {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            // Add new markers
            allDisruptions.forEach((disruption, index) => {
                const color = disruption.severity === 'high' ? '#f44336' : 
                             disruption.severity === 'medium' ? '#ff9800' : '#4caf50';
                
                const icon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background: ${color}; width: 25px; height: 25px; border-radius: 50%; border: 3px solid white; box-shadow: 0 3px 10px rgba(0,0,0,0.4); cursor: pointer;"></div>`,
                    iconSize: [25, 25]
                });
                
                const marker = L.marker([disruption.location.lat, disruption.location.lon], { icon })
                    .bindPopup(`
                        <div style="min-width: 200px;">
                            <strong style="color: #667eea; font-size: 1.1em;">${disruption.type.replace(/_/g, ' ').toUpperCase()}</strong><br>
                            <span style="background: ${color}; color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.8em; font-weight: 700;">${disruption.severity.toUpperCase()}</span><br><br>
                            <strong>Location:</strong> ${disruption.location.name}<br>
                            <strong>Description:</strong><br>${disruption.description}
                        </div>
                    `)
                    .addTo(map);
                
                markers.push(marker);
            });
        }

        // Fly to disruption on map
        function flyToDisruption(index) {
            const disruption = allDisruptions[index];
            map.flyTo([disruption.location.lat, disruption.location.lon], 6, {
                duration: 1.5
            });
            markers[index].openPopup();
        }

        // Filter by severity
        function filterBySeverity(severity) {
            currentFilter = severity;
            
            // Update button states
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            displayDisruptions();
        }

        // Initialize everything
        initializeRiskChart();
        loadDisruptions();

        // Auto-refresh every 30 seconds
        setInterval(loadDisruptions, 30000);
    </script>
</body>
</html>
